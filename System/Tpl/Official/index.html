<include file="Public:header"/>
<div class="container official">
    <ol class="breadcrumb">
        <li><a href="{:U('Index/index')}">首页</a></li>
        <li class="active"><strong>官方推送</strong></li>
    </ol>

    <p class="well-sm">
        <span class="pull-left">平均气温</span>
        <span class="col-lg-1" style="margin-top:-6px;">
            <input type="text" class="form-control" <if condition="$tm neq ''">value="{$tm}"<else/>value="15"</if> id='lttem'/>
        </span>℃
        <button style="margin-top:-6px;" class="btn btn-success" onclick="savetmp();">保存气温</button>
    </p>

    <div id="divedit" style="display: none">
       <div class="form-group">
           <label>按风格检索</label>
           <select name='isstyle'>
               <option value=''>请选择</option>
               <volist id='volstyle' name='stylelist'>
                   <option value="{$volstyle.ID}">{$volstyle.description}</option>
               </volist>
           </select>
           <button class="btn btn-success" id="btnsearch" onclick="searchsuit(1,'');">搜索</button>
       </div>

      <table id="tbsuits" class="table table-striped table-hover text-center table-responsive table-condensed">
          <thead>
          <th style="width: 20%"/>
          <th style="width: 20%"/>
          <th style="width: 20%"/>
          <th style="width: 20%"/>
          <th style="width: 20%"/>
          </thead>
          <tbody>
          </tbody>
      </table>
      <div class="text-right">
          <a href="#" id="hfprepage" title="0" onclick="searchsuit($(this).attr('title'),'per');">上一页</a>
          <a href="#" id="hfnextpage" title="0" onclick="searchsuit($(this).attr('title'),'next');" >下一页</a>
      </div>

  </div>

    <ul id="tab" class="nav nav-tabs">
        <li name="tbcase1" class="active" onclick="changetab(1);"><a href="#home" data-toggle="tab">方案一：当天气温＞边界气温时，用户看到以下推荐套装</a></li>
        <li name="tbcase2"  onclick="changetab(2);"><a href="#news" data-toggle="tab">方案二：当天气温≤边界气温时，用户看到以下推荐套装</a></li>
        <button type="button" id="btnrecomend" class="btn btn-info" onclick="reco();">保存推荐</button>
        <button type="button" id="btnchange" class="btn btn-info" onclick="showedit();">替换推荐</button>
        <button type="button" id="btncancel" class="btn btn-warning" style="display: none" onclick="canceledit();">取消替换</button>
    </ul>
    <div id="divreview">
    <div class="row text-center" style="height:100%" id="divreco1">
          <volist id='vo' name='selsuits1'>
              <div class="col-sm-6 " style="width: 20%" name="divsst{$vo.suitStyleID}">
                  <div class="thumbnail">
                      <div class="caption">
                          <p class="js-official-id">{$vo.description}</p>
                          <div>
                              <img src='{$vo.suitImageUrl}' width='160px' height='200px'>
                          </div>
                          <label class="checkbox-inline">
                              <input type="checkbox" value="{$vo.suitID}" class="delch" name="ckreco" onclick="ckreco($(this),'divreco1');"
                              <if condition="$vo.selected eq 1">checked=true<else/></if>>推荐</label>
                          <label class="checkbox-inline">
                              <input type="checkbox" class="delch" onclick="clickoff($(this));">删除</label>
                      </div>
                  </div>
              </div>
          </volist>
    </div>
    <div class="row text-center" style="height:100%" id="divreco2">
        <volist id='vo' name='selsuits2'>
            <div class="col-sm-6" style="width: 20%" name="divsst{$vo.suitStyleID}">
                <div class="thumbnail">
                    <div class="caption">
                        <p class="js-official-id">{$vo.description}</p>
                        <div>
                            <img src='{$vo.suitImageUrl}' width='160px' height='200px'>
                        </div>
                        <label class="checkbox-inline">
                            <input type="checkbox" value="{$vo.suitID}" class="delch" name="ckreco" onclick="ckreco($(this),'divreco2');"
                            <if condition="$vo.selected eq 1">checked=true<else/></if>>推荐</label>
                        <label class="checkbox-inline">
                            <input type="checkbox" class="delch" onclick="clickoff($(this));">删除</label>
                    </div>
                </div>
            </div>
        </volist>
    </div>
  </div>
</div>
<include file="Public:footer"/>
<script type='text/javascript'>
    var indexurl = "{:U('Official/index')}";
    var savetmpurl = "{:U('Official/savetmp')}";
    var searchurl = "{:U('Official/search')}";
    var recourl = "{:U('Official/recommend')}";
    $('#divreco1').show();
    $('#divreco2').hide();
    function ckreco(e,dv){
        var cknum = 0;
        var maxcknum = 6;
        var msg = "您最多只能推荐6种套装";

        $("#"+dv).find('input[type=checkbox]').each(function(){
            if($(this).prop("checked")==true){
                cknum = cknum + 1;
            }
            if(cknum>maxcknum){
                e.attr("checked",false);
                alert(msg);
                return;
            }
        });
    }

    function showedit(){
        var type = 0
        if($('li[name=tbcase1]').hasClass('active')){
            type =1;
        }
        if($('li[name=tbcase2]').hasClass('active')){
            type =2;
        }
        $('#btncancel').show();
        $('#btnchange').hide();
        $('#divedit').show();
        $("#tbsuits tbody").find("tr").each(function(){
            $(this).find("input[type='checkbox']").each(function(){
                $(this).attr("checked",false);
            });
        });
        $('select[name=isstyle]').focus();
    }

    function canceledit(){
        var type = 0
        if($('li[name=tbcase1]').hasClass('active')){
            type =1;
        }
        if($('li[name=tbcase2]').hasClass('active')){
            type =2;
        }
        $('#btncancel').hide();
        $('#divedit').hide();
        $('#btnchange').show();
        $('#btnchange').focus();
    }

    function selsuit(e,styid,sutid,sutimg,description){
        if(e.prop("checked")==true){
            $("#tbsuits tbody").find("tr").each(function(){
                $(this).find("input[type='checkbox']").each(function(){
                    if($(this).val()!=sutid){
                        $(this).attr("checked",false);
                    }
                });
            });
        }

        var isexit = false;
        var dv = "";

        var type = 0
        if($('li[name=tbcase1]').hasClass('active')){
            type =1;
        }
        if($('li[name=tbcase2]').hasClass('active')){
            type =2;
        }

        if(type==1){
            dv=dv + "divreco1";
        }
        if(type==2){
            dv=dv + "divreco2";
        }
        $("#" + dv).find('div[name=divsst'+ styid +']').each(function(){
            isexit = true;
            if(e.prop("checked")==true){
                $(this).find('img').each(function(){
                    $(this).attr("src", sutimg);
                });
                $(this).find('input[type=checkbox]').each(function(){
                    $(this).val(sutid);
                });
            }else{
                $(this).remove();
            }
            return;
        })
        if(!isexit && e.prop("checked")==true){
            var dvn = "'" + dv + "'";
            var sstdiv = "<div class='col-sm-6' style='width:20%' name='divsst" + styid + "'>"+
                "<div class='thumbnail'>"+ "<div class='caption'>"+
                "<p class='js-official-id'>"+ description+ "</p><div>"+
                "<img src='" + sutimg + "' width='160px' height='200px'></div>"
                +"<label class='checkbox-inline'>"
                +"<input type='checkbox' name='ckreco' value='" + sutid + "' class='delch'" + ' onclick="ckreco($(this),' + dvn + ');">推荐</label>'
                +"<label class='checkbox-inline'>"
                + "<input type='checkbox' class='delch' onclick='clickoff($(this));'>删除</label>"
                +"</div></div></div>"
            $("#" + dv).append(sstdiv);
        }
    }

    function reco(){
        var reco = "";

        $('#divreco1').find("input[name=ckreco]").each(function(){
            if(reco==""){
                reco = "{'type':'1','sid':'"+ $(this).val() +"','reco':'"+ $(this).prop("checked") + "'}"
            }else{
                reco = reco + ",{'type':'1','sid':'"+ $(this).val() +"','reco':'"+ $(this).prop("checked") + "'}"
            }
        })

        $('#divreco2').find("input[name=ckreco]").each(function(){
            if(reco==""){
                reco = "'type':'2',{'sid':'"+ $(this).val() +"','reco':'"+ $(this).prop("checked") + "'}"
            }else{
                reco = reco + ",{'type':'2','sid':'"+ $(this).val() +"','reco':'"+ $(this).prop("checked") + "'}"
            }
        })

        $.post(recourl,{reco:"[" + reco + "]"},function(data,status){
            if(data=="1"){
                alert("已保存推荐套装。");
            }else{
                alert("保存推荐套装失败。");
            }
        });
    }

    function searchsuit(page,act){
        if(act!="" && page=='0'){
            return;
        }

        $.post(searchurl,{
            isstyle : $('select[name=isstyle]').val(),
            page:page,
            act:act
        },function(data,status){
            if(data==""){
                $("#tbsuits tbody").find("tr").each(function(){
                    $(this).remove();
                });
                $('#hfprepage').attr("title","0");
                $('#hfnextpage').attr("title","0");
            }else if(data=="1"){
                return;
            }
            else{
                var da = eval("("+data+")");
                $("#tbsuits tbody").find("tr").each(function(){
                    $(this).remove();
                });
                var tr = $("<tr/>");
                for (var i = 1 ; i<= 4;i++){
                    var styleid = "'" + da[0][String(i)]["styleID"] + "'";
                    var suitid = "'" + da[0][String(i)]["id"] + "'";
                    var suitimg = "'" + da[0][String(i)]["img"] + "'";
                    var suitdesp = "'" + da[0][String(i)]["desp"] + "'";

                    if(da[0][String(i)]["id"]!=""){
                        var td = $("<td/>");
                        var div = $("<div/>");
                        div.append($("<img src='" + da[0][String(i)]["img"] + "' width='270px' height='375px'>"));
                        div.append($("<label class='checkbox-inline'><input type='checkbox' value='" + da[0][String(i)]["id"] + "' class='delch' " +
                                'onclick="selsuit($(this),'+ styleid +','+ suitid +','+ suitimg +','+ suitdesp +');">选择</label>'));
                        td.append(div);
                        tr.append(td);
                    }else{
                        tr.append($("<td/>"));
                    }
                }
                $("#tbsuits tbody").append(tr);

                $('#hfprepage').attr("title",String(da[0]["page"]));
                $('#hfnextpage').attr("title",String(da[0]["page"]));
            }
        });
    }

    function savetmp(){
        $.post(savetmpurl,{
            tmp : $('#lttem').val()
        },function(data,status){
            if(data){
                alert("平均温度已保存");
            }
        });
    }

    function changetab(idx){
        if(idx==1){
            $('#divreco1').show();$('#divreco2').hide();
        }
        if(idx==2){
            $('#divreco2').show();$('#divreco1').hide();
        }
        $("#tbsuits tbody").find("tr").each(function(){
            $(this).find("input[type='checkbox']").each(function(){
                $(this).attr("checked",false);
            });
        });
    }
    function clickoff(e){

        e.parent().parent().find("input[name=ckreco]").each(function(){
            var sid = $(this).val()
            $("#tbsuits tbody").find("tr").each(function(){
                $(this).find("input[type='checkbox']").each(function(){
                    if($(this).val()==sid){
                        $(this).attr("checked",false);
                    }
                });
            });
        });
        e.parent().parent().parent().parent().remove();
    }

</script>